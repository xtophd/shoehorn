## Authors: 
##   Christoph Doerbeck
##
## Summary:
##
##    These tasks configure the "deployhost" with oVirt support
##    and install software/services to support the deployments
##

##
##    Install the OVIRT SDK 
##



- name: "ovirt-setup : install oVirt supporting packages (sdk/api)"
  yum: name=python-ovirt-engine-sdk4 state=installed



## 05-18-2021- MOVED TO COMMON-SETUP.YML
##
##    Install additional required packages
##
#
#
#
#- name: "ovirt-setup : install common supporting packages"
#  yum: name=genisoimage,xorriso,syslinux,git,tree,wget,yum-utils,firewalld,httpd,net-tools,traceroute,nmap state=installed



## 05-18-2021- MOVED TO COMMON-SETUP.YML
##
##    Set up ssh keys
##
#
#
#
#- name: "ovirt-setup : Create ssh directory"
#  file:
#    path: /root/.ssh
#    mode: "0700"
#    state: directory
#
#- name: "ovirt-setup : test deployhost ssh key"
#  stat: path="/root/.ssh/id_rsa.pub"
#  register: test_ssh_key
#
#- name: "ovirt-setup : create deployhost ssh key"
#  command: "ssh-keygen -t rsa -b 2048 -N '' -f /root/.ssh/id_rsa"
#  when: test_ssh_key.stat.exists == false



## 05-18-2021- MOVED TO COMMON-SETUP.YML
##
##   Set up ISO directories 
##
#
#
#
#- name: "ovirt-setup : create iso directory"
#  file:
#    path: "{{ xtoph_deploy.deployhost.iso.dir }}"
#    mode: "0755"
#    owner: "root"
#    group: "root"
#    state: directory



## 05-18-2021- MOVED TO COMMON-SETUP.YML
##
##   Configure httpd to support kickstarts
##
#
#
#
#- name: "ovirt-setup: deploy httpd configuration"
#  vars:
#    - p_port: "{{ xtoph_deploy.deployhost.http_port }}"
#  template:
#    src: "deployhost-httpd-conf.j2"
#    dest: "/etc/httpd/conf/httpd.conf"
#    owner: root
#    group: root
#    mode: 0644
#
#- name: "ovirt-setup: selinux restorecon on /var/www/html"
#  shell: restorecon -R /var/www/html



## 05-18-2021- MOVED TO COMMON-SETUP.YML
##
##   Enable system services
##
#
#
#
#- name: "ovirt-setup : enable system services"
#  service: name="{{ item }}" state=restarted enabled=yes masked=no
#  with_items:
#    - "NetworkManager"
#    - "firewalld"
#    - "httpd"



## 05-18-2021- MOVED TO COMMON-SETUP.YML
##
##   Enable firewall services/ports
##
#
#
#
#- name: "ovirt-setup : add firewalld services"
#  firewalld:
#    service: "{{ item }}"
#    immediate: yes
#    permanent: yes
#    state: enabled
#  with_items:
#    - "http"
#    - "https"
#
#- name: "ovirt-setup : add firewalld ports"
#  firewalld:
#    port: "{{ item }}"
#    immediate: yes
#    permanent: yes
#    state: enabled
#  with_items:
#    - "{{ xtoph_deploy.deployhost.http_port }}/tcp"



## 05-18-2021- MOVED TO COMMON-SETUP.YML
##
##    Install and enable dnsmasq services/ports
##
#
#
#
#- block:
#
#      - name: "ovirt-setup : install dnsmasq package"
#        yum: name=dnsmasq state=installed
#
#      - name: "ovirt-setup : adjust /etc/dnsmasq.conf with except-interface"
#        lineinfile:
#          dest: "/etc/dnsmasq.conf"
#          insertafter: "^#except-interface=.*$"
#          line: "except-interface=virbr0"
#          state: present
#
#      - name: "ovirt-setup : adjust /etc/dnsmasq.conf with bind-interfaces"
#        lineinfile:
#          dest: "/etc/dnsmasq.conf"
#          insertafter: "^#bind-interfaces.*$"
#          line: "bind-interfaces"
#          state: present
#
#      - name: "ovirt-setup :  enable dnsmasq system services"
#        service: name="dnsmasq" state=restarted enabled=yes masked=no
#
#      - name: "ovirt-setup :  add dns firewalld services"
#        firewalld:
#          service:   "dns"
#          immediate: yes
#          permanent: yes
#          state: enabled
#
#  when: xtoph_deploy.deployhost.dnsmasq_enable == true



##   
##    NOTE: I should probably just develop a selinux 
##          test to see if port needs to be added  
##   
##    NOTE: If we use a port not natively included 
##          by default selinux profiles, we need to add it
##   
##     - name: "ovirt-ovirt-setup:  add http port to selinux http_port_t"
##     - shell:
##         cmd: |
##           semanage port -a -t http_port_t -p tcp {{ xtoph_deploy.deployhost.http_port }}

